<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>Support Portal</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; padding: 20px; text-align: center; background: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); }
    textarea { width: 100%; height: 120px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; margin-bottom: 20px; background: var(--tg-theme-secondary-bg-color, #f0f0f0); color: var(--tg-theme-text-color, #000); }
    button { width: 100%; padding: 14px; background-color: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #fff); border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
    button:disabled { opacity: 0.7; cursor: not-allowed; }
    #status { margin-top: 15px; font-size: 14px; color: #666; }
  </style>
</head>
<body>

  <h2 id="greeting">Loading...</h2>
  <textarea id="desc" placeholder="Describe your issue..."></textarea>
  <button id="btn" onclick="submitTicket()">Submit Ticket</button>
  <div id="status"></div>

  <script>
    // --- CONFIGURATION ---
    // PASTE YOUR GOOGLE DEPLOYMENT URL HERE (The one ending in /exec)
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwDtEIYZMFQkLifxS55nhiN_11ABJcOng1xR101k__NrXP1B70HsbJWMGHFFM3oWpqiYQ/exec"; 

    // --- LOGIC ---
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    // 1. Immediate User Detection (No Redirects to break it!)
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
      document.getElementById('greeting').innerText = `Hi, ${tg.initDataUnsafe.user.first_name}`;
    } else {
      document.getElementById('greeting').innerText = "Hi, Guest";
    }

    function submitTicket() {
      const desc = document.getElementById('desc').value;
      if (!desc) return tg.showAlert("Please describe the issue.");

      const btn = document.getElementById('btn');
      const status = document.getElementById('status');
      
      btn.disabled = true;
      btn.innerText = "Processing with AI...";
      status.innerText = "Sending to Support Team...";

      // Prepare Data
      const payload = {
        description: desc,
        userId: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 0,
        username: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.username : 'Unknown'
      };

      // Send to Google via 'fetch' (API Call)
      fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          tg.showAlert(`Ticket Created! ID: ${data.taskId}`);
          tg.close();
        } else {
          throw new Error(data.error);
        }
      })
      .catch(err => {
        btn.disabled = false;
        btn.innerText = "Try Again";
        status.innerText = "Error: " + err.message;
      });
    }
  </script>
</body>
</html>
